---
# tasks file for deploy_rhcsa_reposerver

- name: Create /mnt/repos directory
  ansible.builtin.file:
    path: /mnt/repos
    state: directory
    mode: 0755
    owner: root
    group: root
    setype: httpd_sys_content_t

- name: Change contexts for repos
  community.general.sefcontext:
    target: '/mnt/repos(/.*)?'
    setype: httpd_sys_content_t
    state: present

- name: Run restorecon on /mnt/repos
  ansible.builtin.shell: |
    restorecon -R /mnt/repos
  changed_when: false

- name: Install httpd to serve RHEL Repos
  ansible.builtin.dnf:
    name:
      - httpd
      - podman
    state: present
  retries: 5
  delay: 20
  notify: restart_httpd

- name: Permit traffic in default zone for madness port
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ reposerver_fw_port }}"
  notify:
    - restart_firewalld

- name: Permit traffic in default zone for http service
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ reposerver_fw_svc }}"
  notify:
    - restart_firewalld

- name: Create a symlink from /var/www/html/repos to /mnt/repos
  ansible.builtin.file:
    src: /mnt/repos
    dest: /var/www/html/repos
    owner: root
    group: root
    state: link

- name: Create a logical volume of 5G
  community.general.lvol:
    vg: rootvg
    lv: madnesslv
    size: 5G

- name: Create the filesystem for the madness logical volume
  community.general.filesystem:
    fstype: xfs
    dev: /dev/rootvg/madnesslv

- name: Mount filesystem
  ansible.posix.mount:
    path: /docs
    src: /dev/rootvg/madnesslv
    fstype: xfs
    state: mounted

- name: Fix permissions for /docs
  ansible.builtin.file:
    path: /docs
    owner: root
    mode: 0755
    seuser: system_u

- name: Change contexts for /docs
  community.general.sefcontext:
    target: '/docs(/.*)?'
    setype: container_file_t
    state: present

- name: Copy madness.yml file into place
  ansible.builtin.copy:
    src: madness.yml
    dest: /docs/.madness.yml
    mode: 0644
    owner: root
    group: root

- name: Run restorecon on /docs
  ansible.builtin.shell: |
    restorecon -R /docs
  changed_when: false

- name: Install Madness for markdown docs
  containers.podman.podman_image:
    name: docker.io/dannyben/madness

- name: Start podman container
  ansible.builtin.command: 'podman run -d --name madness -v /docs:/docs -p 3000:3000 dannyben/madness server'
  changed_when: false
  failed_when: false

- name: Create at job to sync the repos
  ansible.posix.at:
    command: reposync -q -p /mnt/repos/{{ repo['name'] }} --download-metadata --norepopath --repoid={{ repo['repoid'] }}
    count: 2
    units: minutes
  loop: "{{ reposync_repos }}"
  loop_control:
    loop_var: repo

...
