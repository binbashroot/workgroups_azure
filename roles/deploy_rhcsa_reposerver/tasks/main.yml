---
# tasks file for deploy_rhcsa_reposerver
- name: Install httpd to serve RHEL Repos
  ansible.builtin.dnf:
    name: httpd
    state: present

- name: permit traffic in default zone for http service
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ reposerver_fw_svc }}"
  notify: 
    - restart_firewalld
    - restart_htttpd
  
- name: "Sync Red Hat Repos - Be patient"
  ansible.builtin.shell: | 
    reposync -q -p /mnt/repos/{{ item['name'] }} --download-metadata --norepopath --repoid={{ item['repoid'] }}
  loop: "{{ reposync_repos }}"
  args:
    chdir: /mnt
  async: 600
  poll: 15

- name: Change contexts for repos
  community.general.sefcontext:
    target: '/mnt/repos(/.*)?'
    setype: httpd_sys_content_t
    state: present
  loop: "{{ reposync_repos }}"

- name: Create a symlink from /var/www/html/repos to /mnt/repos
  ansible.builtin.file:
    src: /mnt/repos
    dest: /var/www/html/repos
    owner: root
    group: root
    state: link

- name: Flush Handlers
  ansible.builtin.meta: flush_handlers

...
